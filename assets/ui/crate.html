<link rel="stylesheet" href="{{CDN_ASSETS_URL}}/ui/css/app.css">

<div class="stash-overlay" style="display:flex; backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); background: rgba(0,0,0,0.35);">
  <div class="stash-container">
    <button class="close-btn" id="crate-close">↩</button>
    <div class="stash-content glass-surface glass-border-strong">
      <div class="inventory-side">
        <div class="inventory-section glass-surface">
          <h3 class="section-title">BACKPACK</h3>
          <div class="backpack-grid" id="inv-grid" data-container="backpack"></div>
        </div>
        <div class="inventory-section glass-surface">
          <h3 class="section-title">HOTBAR</h3>
          <div class="hotbar-grid" id="hotbar-grid" data-container="hotbar"></div>
        </div>
      </div>
      <div class="stash-side">
        <div class="inventory-section glass-surface">
          <h3 class="section-title">CRATE</h3>
          <div class="stash-grid" id="crate-grid" data-container="crate"></div>
        </div>
      </div>
    </div>
    <div class="drag-ghost"></div>
  </div>
</div>

<template id="crate-slot">
  <div class="stash-slot"></div>
  </template>

<script>
  const CDN_ASSETS_URL = '{{CDN_ASSETS_URL}}';
  const grid = document.getElementById('crate-grid');
  const invGrid = document.getElementById('inv-grid');
  const hotbarGrid = document.getElementById('hotbar-grid');
  const closeBtn = document.getElementById('crate-close');
  const tpl = document.getElementById('crate-slot');
  let currentCrateId = null;
  let crateDragState = null;
  let dropHoverSlot = null;
  const dragGhost = document.querySelector('.drag-ghost');

  closeBtn.addEventListener('click', () => {
    hytopia.sendData({ type: 'crate-close', crateId: currentCrateId });
    hytopia.sendData({ type: 'requestHudSync' });
  });

  // ESC to close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      hytopia.sendData({ type: 'crate-close', crateId: currentCrateId });
      hytopia.sendData({ type: 'requestHudSync' });
      // Ask server to re-broadcast current weapon HUD to avoid "No Weapon" state
      hytopia.sendData({ type: 'requestWeaponHud' });
    }
  });

  function setupGrid(container, size, width, slotClass) {
    container.innerHTML = '';
    for (let i = 0; i < size; i++) {
      const node = tpl.content.cloneNode(true);
      const slot = node.querySelector('.stash-slot');
      slot.className = slotClass;
      slot.setAttribute('data-position', i.toString());
      container.appendChild(node);
    }
    container.style.gridTemplateColumns = `repeat(${width}, 1fr)`;
  }

  function updateSlot(container, position, itemData) {
    const slot = container.children[position];
    if (!slot) return;
    if (!itemData || itemData.removed) {
      slot.innerHTML = '';
      slot._itemData = null;
      return;
    }
    const isAmmo = itemData.name && (
      itemData.name.includes('9×19mm') || itemData.name.includes('7.62×39mm') || itemData.name.includes('12.7×108mm') || itemData.name.includes('12 Gauge')
    );
    let quantityDisplay = '';
    if (itemData.quantity && itemData.quantity > 1) {
      quantityDisplay = `<span class="${isAmmo ? 'ammo-label' : 'item-quantity'}">${itemData.quantity}</span>`;
    }
    slot.innerHTML = `<img src="${CDN_ASSETS_URL}/${itemData.iconImageUri || 'icons/chest.png'}" alt="${itemData.name || ''}">${quantityDisplay}`;
    slot._itemData = itemData;

    slot.onmousedown = (e) => {
      if (e.shiftKey && e.button === 0) {
        e.preventDefault();
        const from = slot.classList.contains('backpack-slot') ? 'backpack' : slot.classList.contains('hotbar-slot') ? 'hotbar' : 'crate';
        const fromIndex = parseInt(slot.getAttribute('data-position'));
        hytopia.sendData({ type: 'crate-quickMove', crateId: currentCrateId, fromType: from, fromIndex });
        return;
      }
      if (e.button !== 0 || !slot.querySelector('img')) return;
      e.preventDefault();
      const from = slot.classList.contains('backpack-slot') ? 'backpack' : slot.classList.contains('hotbar-slot') ? 'hotbar' : 'crate';
      crateDragState = { slot, from, fromIndex: parseInt(slot.getAttribute('data-position')), startX: e.clientX, startY: e.clientY, isDragging: false };
      document.addEventListener('mousemove', handleDragMove, { capture: true });
      document.addEventListener('mouseup', handleDragUp);
    };
  }

  function handleDragMove(e) {
    if (!crateDragState) return;
    const dx = e.clientX - crateDragState.startX;
    const dy = e.clientY - crateDragState.startY;
    if (!crateDragState.isDragging && (Math.abs(dx) > 5 || Math.abs(dy) > 5)) {
      crateDragState.isDragging = true;
      startDragGhost(crateDragState.slot);
      setEmptySlotHighlighting(true);
    }
    if (crateDragState.isDragging) {
      dragGhost.style.left = `${e.clientX + 15}px`;
      dragGhost.style.top = `${e.clientY - 15}px`;
      dragGhost.style.transform = 'translate(-50%, -50%)';
      updateDropHover(e);
    }
  }

  function handleDragUp(e) {
    if (crateDragState && crateDragState.isDragging) {
      const dropSlot = document.elementFromPoint(e.clientX, e.clientY)?.closest('.stash-slot, .hotbar-slot, .backpack-slot');
      if (dropSlot && dropSlot !== crateDragState.slot) {
        let to = dropSlot.classList.contains('backpack-slot') ? 'backpack' : dropSlot.classList.contains('hotbar-slot') ? 'hotbar' : 'crate';
        const toIndex = parseInt(dropSlot.getAttribute('data-position')) || Array.from(dropSlot.parentElement.children).indexOf(dropSlot);
        hytopia.sendData({ type: 'crate-move', crateId: currentCrateId, fromType: crateDragState.from, fromIndex: crateDragState.fromIndex, toType: to, toIndex });
      }
    }
    finalizeDragVisuals();
    setEmptySlotHighlighting(false);
    document.removeEventListener('mousemove', handleDragMove);
    document.removeEventListener('mouseup', handleDragUp);
    crateDragState = null;
  }

  function startDragGhost(slot) {
    dragGhost.innerHTML = '';
    const img = slot.querySelector('img');
    if (img) dragGhost.appendChild(img.cloneNode(true));
    dragGhost.classList.add('active');
  }

  function stopDragGhost() {
    dragGhost.classList.remove('active');
    dragGhost.innerHTML = '';
  }

  function setEmptySlotHighlighting(enable) {
    document.querySelectorAll('.stash-slot, .backpack-slot, .hotbar-slot').forEach(slot => {
      if (enable) {
        if (!slot.querySelector('img')) slot.classList.add('drop-target');
        else slot.classList.remove('drop-target');
      } else {
        slot.classList.remove('drop-target', 'drop-hover');
      }
    });
  }

  function updateDropHover(e) {
    const candidate = document.elementFromPoint(e.clientX, e.clientY)?.closest('.stash-slot, .hotbar-slot, .backpack-slot');
    const isEmpty = candidate && !candidate.querySelector('img');
    if (dropHoverSlot && dropHoverSlot !== candidate) {
      dropHoverSlot.classList.remove('drop-hover');
      dropHoverSlot = null;
    }
    if (isEmpty) {
      candidate.classList.add('drop-hover');
      dropHoverSlot = candidate;
    }
  }

  function finalizeDragVisuals() {
    document.querySelectorAll('.stash-slot, .backpack-slot, .hotbar-slot').forEach(slot => slot.classList.remove('drop-target', 'drop-hover'));
    stopDragGhost();
  }

  // number keys assignment like stash
  document.addEventListener('keydown', (e) => {
    const key = parseInt(e.key);
    if (!isNaN(key) && key >= 1 && key <= 9) {
      const hovered = document.querySelector('.stash-slot:hover, .backpack-slot:hover, .hotbar-slot:hover');
      if (!hovered) return;
      const numberIndex = key - 1;
      const hoveredIndex = parseInt(hovered.getAttribute('data-position')) || Array.from(hovered.parentElement.children).indexOf(hovered);
      const isBackpackSlot = hovered.classList.contains('backpack-slot');
      const isHotbarSlot = hovered.classList.contains('hotbar-slot');
      const isCrateSlot = hovered.classList.contains('stash-slot');
      if (hovered.querySelector('img')) {
        const fromType = isBackpackSlot ? 'backpack' : isHotbarSlot ? 'hotbar' : 'crate';
        hytopia.sendData({ type: 'crate-move', crateId: currentCrateId, fromType, fromIndex: hoveredIndex, toType: 'hotbar', toIndex: numberIndex });
        finalizeDragVisuals();
      } else if (isBackpackSlot) {
        hytopia.sendData({ type: 'crate-move', crateId: currentCrateId, fromType: 'hotbar', fromIndex: numberIndex, toType: 'backpack', toIndex: hoveredIndex });
        finalizeDragVisuals();
      } else if (isCrateSlot) {
        hytopia.sendData({ type: 'crate-move', crateId: currentCrateId, fromType: 'hotbar', fromIndex: numberIndex, toType: 'crate', toIndex: hoveredIndex });
        finalizeDragVisuals();
      }
    }
  });

  function renderAll(crates, inv, hotbar) {
    // clear all slots first
    for (let i = 0; i < grid.children.length; i++) updateSlot(grid, i, { removed: true });
    for (let i = 0; i < invGrid.children.length; i++) updateSlot(invGrid, i, { removed: true });
    for (let i = 0; i < hotbarGrid.children.length; i++) updateSlot(hotbarGrid, i, { removed: true });
    // apply payloads
    (crates || []).forEach(it => updateSlot(grid, it.position, it));
    (inv || []).forEach(it => updateSlot(invGrid, it.position, it));
    (hotbar || []).forEach(it => updateSlot(hotbarGrid, it.position, it));
  }

  hytopia.onData(data => {
    if (data.type === 'crate-contents') {
      currentCrateId = data.crateId;
      const width = data.gridWidth || 9;
      const size = data.size || 72;
      setupGrid(grid, size, width, 'stash-slot');
      setupGrid(invGrid, 27, 9, 'backpack-slot');
      setupGrid(hotbarGrid, 9, 9, 'hotbar-slot');
      renderAll(data.items || data.crate || [], data.inventory || [], data.hotbar || []);
      hytopia.lockPointer(false, true);
      // Server will push crate-sync after moves; initial payload already has inventories
    }
    if (data.type === 'crate-sync') {
      renderAll(data.crate || [], data.inventory || [], data.hotbar || []);
    }
  });
</script>


