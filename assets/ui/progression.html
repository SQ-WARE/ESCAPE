<link rel="stylesheet" href="{{CDN_ASSETS_URL}}/ui/css/app.css">
<link rel="stylesheet" href="{{CDN_ASSETS_URL}}/ui/css/progression.css">
<link rel="preload" as="image" href="{{CDN_ASSETS_URL}}/ui/background2.png">
<!-- Preload other page assets -->
<link rel="preload" as="stylesheet" href="{{CDN_ASSETS_URL}}/ui/css/stash.css">
<link rel="preload" as="stylesheet" href="{{CDN_ASSETS_URL}}/ui/css/market.css">
<!-- Page Loading System -->
<div class="page-loading-spinner" id="page-loading-spinner"></div>
<div class="page-transition-overlay" id="page-transition-overlay"></div>

<div class="menu-background" style="background: url('{{CDN_ASSETS_URL}}/ui/background2.png') center center / cover no-repeat;">
  <div class="background-overlay"></div>
  <div class="smoke-effect">
    <div class="smoke-layer smoke-layer-1"></div>
    <div class="smoke-layer smoke-layer-2"></div>
    <div class="smoke-layer smoke-layer-3"></div>
  </div>
</div>

<div class="progression-overlay page-loading" id="progression-overlay-content" style="display: flex; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); background: rgba(0,0,0,0.25);">
  <div class="progression-interface">
    <!-- Header Panel -->
    <div class="progression-header-panel">
      <div class="progression-title-section">
        <h1 class="progression-title">COMBAT RECORD</h1>
        <div class="progression-subtitle">ESCAPE</div>
      </div>
      <div class="progression-controls">
        <button class="close-btn-progression" id="progression-close-btn">CLOSE</button>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="progression-content-panel">
      <div class="progression-tabs">
        <button class="tab-btn active" data-tab="stats">STATISTICS</button>
        <button class="tab-btn" data-tab="weapons">WEAPONS</button>
        <button class="tab-btn" data-tab="achievements">ACHIEVEMENTS</button>
      </div>
      <div class="progression-content" id="progression-content"></div>
    </div>
  </div>
</div>

<script>
  const CDN_ASSETS_URL = '{{CDN_ASSETS_URL}}';
  const progressionTabs = document.querySelectorAll('.tab-btn');
  let activeTab = 'stats';
  let cachedData = {};

  // Page Loading & Transition System - Optimized
  const pageLoadingSpinner = document.getElementById('page-loading-spinner');
  const pageTransitionOverlay = document.getElementById('page-transition-overlay');
  const progressionOverlayContent = document.getElementById('progression-overlay-content');
  
  let isTransitioning = false;
  let transitionTimeout = null;
  let isInitialized = false;

  // Initialize loading spinner
  function initializeLoadingSpinner() {
    if (pageLoadingSpinner) {
      pageLoadingSpinner.classList.add('active');
    }
  }

  // Page loading system with error handling
  function showPageLoading() {
    if (pageLoadingSpinner && !pageLoadingSpinner.classList.contains('active')) {
      pageLoadingSpinner.classList.add('active');
    }
  }

  function hidePageLoading() {
    if (pageLoadingSpinner && pageLoadingSpinner.classList.contains('active')) {
      pageLoadingSpinner.classList.remove('active');
    }
  }

  function showPageTransition() {
    if (pageTransitionOverlay && !pageTransitionOverlay.classList.contains('active')) {
      pageTransitionOverlay.classList.add('active');
    }
  }

  function hidePageTransition() {
    if (pageTransitionOverlay && pageTransitionOverlay.classList.contains('active')) {
      pageTransitionOverlay.classList.remove('active');
    }
  }

  function navigateBackToMenu() {
    // Prevent multiple simultaneous transitions
    if (isTransitioning) {
      console.warn('Page transition already in progress, ignoring navigation request');
      return;
    }

    isTransitioning = true;

    try {
      // Show transition overlay
      showPageTransition();
      
      // Add fade out animation to current content
      if (progressionOverlayContent) {
        progressionOverlayContent.classList.add('overlay-scale-out');
      }
      
      // Clear any existing timeout
      if (transitionTimeout) {
        clearTimeout(transitionTimeout);
      }
      
      // After fade out, navigate
      transitionTimeout = setTimeout(() => {
        try {
          hytopia.sendData({ type: 'backToMenu' });
        } catch (error) {
          console.error('Failed to send navigation data:', error);
          // Revert transition on error
          revertTransition();
        }
      }, 300);
    } catch (error) {
      console.error('Navigation error:', error);
      revertTransition();
    }
  }

  function revertTransition() {
    isTransitioning = false;
    hidePageTransition();
    
    if (progressionOverlayContent) {
      progressionOverlayContent.classList.remove('overlay-scale-out');
    }
    
    if (transitionTimeout) {
      clearTimeout(transitionTimeout);
      transitionTimeout = null;
    }
  }

  // Initialize page when everything is loaded
  function initializePage() {
    if (isInitialized) {
      console.warn('Page already initialized, skipping');
      return;
    }

    try {
      // Hide loading spinner
      hidePageLoading();
      
      // Show main content with scale in
      if (progressionOverlayContent) {
        progressionOverlayContent.classList.remove('page-loading');
        progressionOverlayContent.classList.add('page-loaded', 'overlay-scale-in');
      }
      
      isInitialized = true;
      
      // Initialize the default tab after page loads
      setTimeout(() => {
        try {
          setActiveTab('stats');
        } catch (error) {
          console.error('Failed to set active tab:', error);
        }
      }, 100);
    } catch (error) {
      console.error('Page initialization error:', error);
      // Fallback: show content without animation
      if (progressionOverlayContent) {
        progressionOverlayContent.classList.remove('page-loading');
        progressionOverlayContent.classList.add('page-loaded');
      }
      isInitialized = true;
    }
  }

  // Wait for DOM and critical resources to load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializePage, 100);
    });
  } else {
    // DOM is already loaded
    setTimeout(initializePage, 100);
  }

  // Initialize loading spinner immediately
  initializeLoadingSpinner();

  // Handle page visibility changes (tab switching)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && isTransitioning) {
      // Page hidden during transition, revert
      revertTransition();
    }
  });

  // Handle window focus/blur
  window.addEventListener('blur', () => {
    if (isTransitioning) {
      // Window lost focus during transition, revert
      revertTransition();
    }
  });

  // Handle beforeunload to clean up
  window.addEventListener('beforeunload', () => {
    if (isTransitioning) {
      revertTransition();
    }
  });

  // Handle progression close
  const progressionCloseBtn = document.getElementById('progression-close-btn');
  if (progressionCloseBtn) {
    progressionCloseBtn.addEventListener('click', () => {
      // Use new navigation system
      navigateBackToMenu();
    });
  }

  progressionTabs.forEach(btn => {
    btn.addEventListener('click', () => setActiveTab(btn.getAttribute('data-tab')));
  });

  // Initialize the page by loading the default tab (stats)
  setTimeout(() => {
    setActiveTab('stats');
  }, 50);

  // Add fade-in effect on page load
  document.addEventListener('DOMContentLoaded', () => {
    const progressionOverlay = document.querySelector('.progression-overlay');
    if (progressionOverlay) {
      progressionOverlay.classList.add('fade-in-scale');
    }
  });

  function setActiveTab(tab) {
    activeTab = tab;
    progressionTabs.forEach(b => b.classList.toggle('active', b.getAttribute('data-tab') === tab));
    const content = document.getElementById('progression-content');
    content.innerHTML = '';
    
    if (tab === 'stats') {
      setTimeout(() => { try { hytopia.sendData({ type: 'requestProgressOverview' }); } catch {} }, 10);
    } else if (tab === 'weapons') {
      setTimeout(() => { try { hytopia.sendData({ type: 'openProgression' }); } catch {} }, 10);
    } else if (tab === 'achievements') {
      renderAchievementsTab();
    }
  }

  hytopia.onData(data => {
    switch (data.type) {
      case 'progress-overview':
        cachedData.overview = data;
        if (activeTab === 'stats') {
          renderStatsTab();
        }
        break;
      case 'weapon-progress':
        cachedData.weapons = data.rows || [];
        if (activeTab === 'weapons') renderWeaponProgress(data.rows || []);
        break;
      case 'openProgression':
        if (activeTab === 'weapons') {
          setTimeout(() => { try { hytopia.sendData({ type: 'openProgression' }); } catch {} }, 10);
        }
        break;
    }
  });

  // Fallback: Request data if stats tab is active but no data after 200ms
  setTimeout(() => {
    if (activeTab === 'stats' && (!cachedData.overview || !cachedData.overview.kills)) {
      try { hytopia.sendData({ type: 'requestProgressOverview' }); } catch {}
    }
  }, 200);



  function renderWeaponProgress(rows) {
    const container = document.getElementById('progression-content');
    if (!container) return;
    
    // Group rows by category and render headings
    const groups = new Map();
    rows.forEach(r => {
      const cat = String(r.category || '').toLowerCase();
      if (!groups.has(cat)) groups.set(cat, []);
      groups.get(cat).push(r);
    });
    
    const order = ['pistol','smg','rifle','shotgun','sniper','lmg',''];
    const titleMap = { 
      pistol: 'PISTOLS', 
      smg: 'SMGs', 
      rifle: 'RIFLES', 
      shotgun: 'SHOTGUNS', 
      sniper: 'SNIPERS', 
      lmg: 'LMGs', 
      '': 'OTHER' 
    };

    container.innerHTML = `
      <div class="weapons-header">
        <div class="weapons-title">
          <h2>WEAPON MASTERY</h2>
          <p>Track your progress across all weapon categories</p>
        </div>
        <div class="weapons-summary">
          <div class="summary-stat">
            <span class="summary-number">${rows.length}</span>
            <span class="summary-label">WEAPONS</span>
          </div>
          <div class="summary-stat">
            <span class="summary-number">${rows.reduce((sum, r) => sum + r.kills, 0)}</span>
            <span class="summary-label">TOTAL KILLS</span>
          </div>
        </div>
      </div>
    `;

    order.forEach(cat => {
      const list = groups.get(cat);
      if (!list || list.length === 0) return;
      
      const categorySection = document.createElement('div');
      categorySection.className = 'weapon-category-section';
      
      const heading = document.createElement('div');
      heading.className = 'weapon-category-header';
      heading.innerHTML = `
        <div class="category-title">${titleMap[cat] || (cat ? cat.charAt(0).toUpperCase()+cat.slice(1) : 'OTHER')}</div>
        <div class="category-stats">
          <span>${list.length} weapons</span>
          <span>â€¢</span>
          <span>${list.reduce((sum, r) => sum + r.kills, 0)} kills</span>
        </div>
      `;
      categorySection.appendChild(heading);
      
      const weaponsGrid = document.createElement('div');
      weaponsGrid.className = 'weapons-grid';
      
      list.forEach(function(row) {
        const pct = Math.min(100, Math.floor((row.kills/row.nextKills)*100));
        const item = document.createElement('div');
        item.className = 'weapon-card ui-panel';
        item.innerHTML = `
          <div class="weapon-card-header">
            <div class="weapon-icon-container">
              <img class="weapon-icon" src="${CDN_ASSETS_URL}/${row.iconImageUri}"/>
            </div>
            <div class="weapon-info">
              <div class="weapon-name">${row.name}</div>
              <div class="weapon-category">${row.category.toUpperCase()}</div>
            </div>
            <div class="weapon-kills">
              <span class="kills-number">${row.kills}</span>
              <span class="kills-label">KILLS</span>
            </div>
          </div>
          <div class="weapon-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width:${pct}%"></div>
          </div>
            <div class="progress-text">
              <span>${row.kills}/${row.nextKills} kills</span>
              <span class="next-reward">+${row.nextXP} XP</span>
            </div>
          </div>
        `;
        weaponsGrid.appendChild(item);
        
        const img = item.querySelector('.weapon-icon');
        const container = item.querySelector('.weapon-icon-container');
        if (img && container) applyDynamicIconTheme(img, container);
      });
      
      categorySection.appendChild(weaponsGrid);
      container.appendChild(categorySection);
    });
  }

  function renderStatsTab() {
    const content = document.getElementById('progression-content');
    const data = cachedData.overview || {};
    
    // Show loading state if no data yet
    if (!data.kills && !data.deaths && !data.currency) {
      content.innerHTML = `
        <div class="stats-tab-content">
          <div class="stats-overview ui-panel">
            <h3>DETAILED STATISTICS</h3>
            <div style="text-align: center; padding: 40px; color: #ccc;">
              <div>Loading statistics...</div>
            </div>
          </div>
        </div>
      `;
      return;
    }
    
    content.innerHTML = `
      <div class="stats-tab-content">
        <div class="stats-overview ui-panel">
          <h3>DETAILED STATISTICS</h3>
          <div class="stats-grid-detailed">
            <div class="stat-detail-card">
              <div class="stat-detail-content">
                <div class="stat-detail-value">${data.kills || 0}</div>
                <div class="stat-detail-label">TOTAL KILLS</div>
                <div class="stat-detail-desc">Enemies eliminated</div>
              </div>
            </div>
            <div class="stat-detail-card">
              <div class="stat-detail-content">
                <div class="stat-detail-value">${data.deaths || 0}</div>
                <div class="stat-detail-label">TOTAL DEATHS</div>
                <div class="stat-detail-desc">Times eliminated</div>
              </div>
            </div>
            <div class="stat-detail-card">
              <div class="stat-detail-content">
                <div class="stat-detail-value">${((data.kills || 0) / Math.max(1, (data.deaths || 0))).toFixed(2)}</div>
                <div class="stat-detail-label">K/D RATIO</div>
                <div class="stat-detail-desc">Kill to death ratio</div>
              </div>
            </div>
            <div class="stat-detail-card">
              <div class="stat-detail-content">
                <div class="stat-detail-value">${data.currency || 0}</div>
                <div class="stat-detail-label">CREDITS EARNED</div>
                <div class="stat-detail-desc">Total currency</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="performance-chart ui-panel">
          <h3>PERFORMANCE TRENDS</h3>
          <div class="chart-placeholder">
            <div class="chart-text">Performance tracking coming soon</div>
          </div>
        </div>
      </div>
    `;
  }

  function renderAchievementsTab() {
    const content = document.getElementById('progression-content');
    const achievements = cachedData.overview?.achievements?.achievements || {};
    const totalCompleted = cachedData.overview?.achievements?.totalCompleted || 0;
    const totalXP = cachedData.overview?.achievements?.totalXP || 0;
    const totalSecretFound = cachedData.overview?.achievements?.totalSecretFound || 0;
    const totalLegendary = cachedData.overview?.achievements?.totalLegendary || 0;
    

    
    // Group achievements by category
    const categories = {
      combat: [],
      progression: [],
      exploration: [],
      collection: [],
      mastery: [],
      challenge: [],
      social: [],
      seasonal: []
    };
    
    for (const [id, achievement] of Object.entries(achievements)) {
      if (categories[achievement.category]) {
        categories[achievement.category].push(achievement);
      }
    }
    
    let achievementsHTML = '';
    
    // Render each category
    for (const [category, categoryAchievements] of Object.entries(categories)) {
      if (categoryAchievements.length === 0) continue;
      
      const categoryTitle = category.charAt(0).toUpperCase() + category.slice(1);
      achievementsHTML += `
        <div class="achievement-category">
          <h3 class="category-title">${categoryTitle}</h3>
          <div class="achievements-list">
      `;
      
      for (const achievement of categoryAchievements) {
        const progressPercent = Math.min(100, (achievement.progress / achievement.requirement) * 100);
        let statusText = achievement.completed ? 'COMPLETED' : `${achievement.progress}/${achievement.requirement}`;
        const statusClass = achievement.completed ? 'achievement-completed' : 'achievement-in-progress';
        
        // Handle repeatable achievements
        if (achievement.repeatable && achievement.completions) {
          const maxCompletions = achievement.maxCompletions || 1;
          statusText = `${achievement.completions}/${maxCompletions} COMPLETED`;
        }
        
        achievementsHTML += `
          <div class="achievement-item ui-panel ${achievement.completed ? 'completed' : ''}">
            <div class="achievement-content">
              <div class="achievement-title">${achievement.title}</div>
              <div class="achievement-desc">${achievement.description}</div>
              <div class="achievement-progress">
                <div class="achievement-bar">
                  <div class="achievement-fill" style="width: ${progressPercent}%"></div>
                </div>
                <span class="achievement-status ${statusClass}">${statusText}</span>
              </div>
              ${achievement.completed ? `<div class="achievement-reward">+${achievement.xpReward} XP</div>` : ''}
            </div>
          </div>
        `;
      }
      
      achievementsHTML += `
          </div>
        </div>
      `;
    }
    
    content.innerHTML = `
      <div class="achievements-content">
        <div class="achievements-header">
          <h2>ACHIEVEMENTS</h2>
          <p>Complete objectives to earn achievements and rewards</p>
          <div class="achievements-summary">
            <div class="summary-stat">
              <span class="summary-number">${totalCompleted}</span>
              <span class="summary-label">COMPLETED</span>
            </div>
            <div class="summary-stat">
              <span class="summary-number">${totalXP}</span>
              <span class="summary-label">XP EARNED</span>
            </div>
            <div class="summary-stat">
              <span class="summary-number">${totalSecretFound}</span>
              <span class="summary-label">SECRETS FOUND</span>
            </div>
            <div class="summary-stat">
              <span class="summary-number">${totalLegendary}</span>
              <span class="summary-label">LEGENDARY</span>
            </div>
          </div>
        </div>
        
        ${achievementsHTML}
      </div>
    `;
  }

  function applyDynamicIconTheme(img, wrap) {
    const analyze = () => {
      try {
        const size = 24;
        const canvas = document.createElement('canvas');
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        ctx.drawImage(img, 0, 0, size, size);
        const { data } = ctx.getImageData(0, 0, size, size);
        let sumL = 0, sumR = 0, sumG = 0, sumB = 0, count = 0;
        for (let i = 0; i < data.length; i += 4) {
          const a = data[i+3] / 255;
          if (a < 0.05) continue;
          const r = data[i], g = data[i+1], b = data[i+2];
          const l = 0.2126 * r + 0.7152 * g + 0.0722 * b;
          sumL += l; sumR += r; sumG += g; sumB += b; count++;
        }
        if (count === 0) return;
        const avgL = sumL / count;
        const avgR = sumR / count, avgG = sumG / count, avgB = sumB / count;
        const isDarkIcon = avgL < 120;
        wrap.classList.toggle('theme-light', isDarkIcon);
        wrap.classList.toggle('theme-dark', !isDarkIcon);
        const accent = `rgba(${Math.round(avgR)}, ${Math.round(avgG)}, ${Math.round(avgB)}, 0.35)`;
        wrap.style.setProperty('--icon-accent', accent);
      } catch {}
    };
    try { img.crossOrigin = 'anonymous'; } catch {}
    if (img.complete) analyze();
    else img.addEventListener('load', analyze, { once: true });
  }

  // initial
  setActiveTab('stats');
</script>


