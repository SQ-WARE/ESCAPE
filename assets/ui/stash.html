<link rel="stylesheet" href="{{CDN_ASSETS_URL}}/ui/css/app.css">
<link rel="stylesheet" href="{{CDN_ASSETS_URL}}/ui/css/stash.css">
<link rel="preload" as="image" href="{{CDN_ASSETS_URL}}/ui/background3.png">
<!-- Preload other page assets -->
<link rel="preload" as="stylesheet" href="{{CDN_ASSETS_URL}}/ui/css/market.css">
<link rel="preload" as="stylesheet" href="{{CDN_ASSETS_URL}}/ui/css/progression.css">
<!-- Page Loading System -->
<div class="page-loading-spinner" id="page-loading-spinner"></div>
<div class="page-transition-overlay" id="page-transition-overlay"></div>

<div class="menu-background" style="background: url('{{CDN_ASSETS_URL}}/ui/background3.png') center center / cover no-repeat;">
  <div class="background-overlay"></div>
  <div class="smoke-effect">
    <div class="smoke-layer smoke-layer-1"></div>
    <div class="smoke-layer smoke-layer-2"></div>
    <div class="smoke-layer smoke-layer-3"></div>
  </div>
</div>

<div class="stash-overlay page-loading" id="stash-overlay-content" style="display: flex; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); background: rgba(0,0,0,0.25);">
  <div class="stash-interface">
    <!-- Header Panel -->
    <div class="stash-header-panel">
      <div class="stash-title-section">
        <h1 class="stash-title">INVENTORY</h1>
        <div class="stash-subtitle">MANAGE ITEMS</div>
      </div>
      <div class="stash-controls">
        <button class="close-btn-stash" id="stash-close-btn">CLOSE</button>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="stash-content-panel">
      <div class="inventory-side">
        <div class="inventory-section ui-panel">
          <h3 class="section-title">BACKPACK</h3>
          <div class="backpack-grid" data-container="backpack"></div>
        </div>
        <div class="inventory-section ui-panel">
          <h3 class="section-title">HOTBAR</h3>
          <div class="hotbar-grid" data-container="hotbar"></div>
        </div>
      </div>
      <div class="stash-side">
        <div class="inventory-section ui-panel">
          <h3 class="section-title">STASH</h3>
          <div class="stash-grid" data-container="stash"></div>
        </div>
      </div>
    </div>
    <div class="drag-ghost"></div>
  </div>
</div>

<script>
  const CDN_ASSETS_URL = '{{CDN_ASSETS_URL}}';
  const BACKPACK_SLOTS = 27;
  const HOTBAR_SLOTS = 9;
  const STASH_SLOTS = 90;

  // Page Loading & Transition System - Optimized
  const pageLoadingSpinner = document.getElementById('page-loading-spinner');
  const pageTransitionOverlay = document.getElementById('page-transition-overlay');
  const stashOverlayContent = document.getElementById('stash-overlay-content');
  
  let isTransitioning = false;
  let transitionTimeout = null;
  let isInitialized = false;

  // Initialize loading spinner
  function initializeLoadingSpinner() {
    if (pageLoadingSpinner) {
      pageLoadingSpinner.classList.add('active');
    }
  }

  // Page loading system with error handling
  function showPageLoading() {
    if (pageLoadingSpinner && !pageLoadingSpinner.classList.contains('active')) {
      pageLoadingSpinner.classList.add('active');
    }
  }

  function hidePageLoading() {
    if (pageLoadingSpinner && pageLoadingSpinner.classList.contains('active')) {
      pageLoadingSpinner.classList.remove('active');
    }
  }

  function showPageTransition() {
    if (pageTransitionOverlay && !pageTransitionOverlay.classList.contains('active')) {
      pageTransitionOverlay.classList.add('active');
    }
  }

  function hidePageTransition() {
    if (pageTransitionOverlay && pageTransitionOverlay.classList.contains('active')) {
      pageTransitionOverlay.classList.remove('active');
    }
  }

  function navigateBackToMenu() {
    // Prevent multiple simultaneous transitions
    if (isTransitioning) {
      console.warn('Page transition already in progress, ignoring navigation request');
      return;
    }

    isTransitioning = true;

    try {
      // Clean up any active interactions
      cleanupStashHoverEffects();
      
      // Show transition overlay
      showPageTransition();
      
      // Add fade out animation to current content
      if (stashOverlayContent) {
        stashOverlayContent.classList.add('overlay-scale-out');
      }
      
      // Clear any existing timeout
      if (transitionTimeout) {
        clearTimeout(transitionTimeout);
      }
      
      // After fade out, navigate
      transitionTimeout = setTimeout(() => {
        try {
          hytopia.sendData({ type: 'backToMenu' });
        } catch (error) {
          console.error('Failed to send navigation data:', error);
          // Revert transition on error
          revertTransition();
        }
      }, 300);
    } catch (error) {
      console.error('Navigation error:', error);
      revertTransition();
    }
  }

  function revertTransition() {
    isTransitioning = false;
    hidePageTransition();
    
    if (stashOverlayContent) {
      stashOverlayContent.classList.remove('overlay-scale-out');
    }
    
    if (transitionTimeout) {
      clearTimeout(transitionTimeout);
      transitionTimeout = null;
    }
  }

  // Initialize page when everything is loaded
  function initializePage() {
    if (isInitialized) {
      console.warn('Page already initialized, skipping');
      return;
    }

    try {
      // Hide loading spinner
      hidePageLoading();
      
      // Show main content with scale in
      if (stashOverlayContent) {
        stashOverlayContent.classList.remove('page-loading');
        stashOverlayContent.classList.add('page-loaded', 'overlay-scale-in');
      }
      
      isInitialized = true;
      
      // Request stash data after initialization
      setTimeout(() => {
        try {
          hytopia.sendData({ type: 'requestStashSync' });
        } catch (error) {
          console.error('Failed to request stash sync:', error);
        }
      }, 100);
    } catch (error) {
      console.error('Page initialization error:', error);
      // Fallback: show content without animation
      if (stashOverlayContent) {
        stashOverlayContent.classList.remove('page-loading');
        stashOverlayContent.classList.add('page-loaded');
      }
      isInitialized = true;
    }
  }

  // Wait for DOM and critical resources to load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializePage, 100);
    });
  } else {
    // DOM is already loaded
    setTimeout(initializePage, 100);
  }

  // Initialize loading spinner immediately
  initializeLoadingSpinner();

  // Handle page visibility changes (tab switching)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && isTransitioning) {
      // Page hidden during transition, revert
      revertTransition();
    }
  });

  // Handle window focus/blur
  window.addEventListener('blur', () => {
    if (isTransitioning) {
      // Window lost focus during transition, revert
      revertTransition();
    }
  });

  // Handle beforeunload to clean up
  window.addEventListener('beforeunload', () => {
    if (isTransitioning) {
      revertTransition();
    }
  });

  const stashGrid = document.querySelector('[data-container="stash"]');
  const stashBackpackGrid = document.querySelector('[data-container="backpack"]');
  const stashHotbarGrid = document.querySelector('[data-container="hotbar"]');
  const dragGhost = document.querySelector('.drag-ghost');

  let stashDragState = null;
  let hoveredSlot = null;
  

  const setupGrid = (grid, size, slotClass) => {
    for (let i = 0; i < size; i++) {
      const slot = document.createElement('div');
      slot.className = slotClass;
      slot.setAttribute('data-position', i.toString());
      slot.addEventListener('mouseenter', () => hoveredSlot = slot);
      slot.addEventListener('mouseleave', () => { if (hoveredSlot === slot) hoveredSlot = null; });
      grid.appendChild(slot);
    }
  };

  const initialize = () => {
    setupGrid(stashGrid, STASH_SLOTS, 'stash-slot');
    setupGrid(stashBackpackGrid, BACKPACK_SLOTS, 'backpack-slot');
    setupGrid(stashHotbarGrid, HOTBAR_SLOTS, 'hotbar-slot');
    hytopia.sendData({ type: 'requestStashSync' });
    
    // Add fade-in effect
    const stashOverlay = document.querySelector('.stash-overlay');
    if (stashOverlay) {
      stashOverlay.classList.add('fade-in-scale');
    }
  };

  // Handle stash close
  const stashCloseBtn = document.getElementById('stash-close-btn');
  if (stashCloseBtn) {
    stashCloseBtn.addEventListener('click', () => {
      // Clean up hover effects and tooltips
      cleanupStashHoverEffects();
      
      // Use new navigation system
      navigateBackToMenu();
    });
  }

  // Clean up hover effects and tooltips
  function cleanupStashHoverEffects() {
    // Remove all hover states from slots
    document.querySelectorAll('.stash-slot, .backpack-slot, .hotbar-slot').forEach(slot => {
      slot.classList.remove('drop-target', 'drop-hover');
    });
    
    // Remove any active tooltips
    const tooltips = document.querySelectorAll('.item-tooltip');
    tooltips.forEach(tooltip => {
      tooltip.remove();
    });
    
    // Clear drag ghost
    const dragGhost = document.querySelector('.drag-ghost');
    if (dragGhost) {
      dragGhost.style.display = 'none';
      dragGhost.innerHTML = '';
    }
    
    // Reset hover state
    hoveredSlot = null;
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      return;
    }
    const key = parseInt(e.key);
    if (!isNaN(key) && key >= 1 && key <= HOTBAR_SLOTS) {
      const hovered = document.querySelector('.stash-slot:hover, .backpack-slot:hover, .hotbar-slot:hover');
      if (!hovered) return;

      const numberIndex = key - 1;
      const hoveredIndex = parseInt(hovered.getAttribute('data-position'));
      const isBackpackSlot = hovered.classList.contains('backpack-slot');
      const isHotbarSlot = hovered.classList.contains('hotbar-slot');
      const isStashSlot = hovered.classList.contains('stash-slot');

      if (hovered.querySelector('img')) {
        const fromType = isBackpackSlot ? 'backpack' : isHotbarSlot ? 'hotbar' : 'stash';
        hytopia.sendData({ type: 'moveItem', fromType, fromIndex: hoveredIndex, toType: 'hotbar', toIndex: numberIndex });
        finalizeDragVisuals();
      } else if (isBackpackSlot) {
        hytopia.sendData({ type: 'moveItem', fromType: 'hotbar', fromIndex: numberIndex, toType: 'backpack', toIndex: hoveredIndex });
        finalizeDragVisuals();
      } else if (isStashSlot) {
        hytopia.sendData({ type: 'moveItem', fromType: 'hotbar', fromIndex: numberIndex, toType: 'stash', toIndex: hoveredIndex });
        finalizeDragVisuals();
      }
    }
  });

  document.addEventListener('mousedown', (e) => {
    const slot = e.target.closest('.stash-slot, .backpack-slot, .hotbar-slot');
    if (slot && slot.querySelector('img') && e.button === 0) {
      e.preventDefault();

      if (e.shiftKey) {
        const from = slot.classList.contains('backpack-slot') ? 'backpack' : slot.classList.contains('hotbar-slot') ? 'hotbar' : 'stash';
        const fromIndex = parseInt(slot.getAttribute('data-position'));
        hytopia.sendData({ type: 'quickMoveItem', fromType: from, fromIndex });
        return;
      }

      let from = slot.classList.contains('backpack-slot') ? 'backpack' : slot.classList.contains('hotbar-slot') ? 'hotbar' : 'stash';
      stashDragState = { slot, from, fromIndex: parseInt(slot.getAttribute('data-position')), startX: e.clientX, startY: e.clientY, isDragging: false };
      document.addEventListener('mousemove', handleDragMove, { capture: true });
      document.addEventListener('mouseup', handleDragUp);
    }
  });

  const handleDragMove = e => {
    if (!stashDragState) return;
    const dx = e.clientX - stashDragState.startX;
    const dy = e.clientY - stashDragState.startY;
    if (!stashDragState.isDragging && (Math.abs(dx) > 5 || Math.abs(dy) > 5)) {
      stashDragState.isDragging = true;
      setEmptySlotHighlighting(true);
      startDragGhost(stashDragState.slot);
    }
    if (stashDragState.isDragging) {
      dragGhost.style.left = `${e.clientX + 15}px`;
      dragGhost.style.top = `${e.clientY - 15}px`;
      dragGhost.style.transform = 'translate(-50%, -50%)';
      updateDropHover(e);
    }
  };

  const handleDragUp = e => {
    if (stashDragState && stashDragState.isDragging) {
      const dropSlot = document.elementFromPoint(e.clientX, e.clientY)?.closest('.stash-slot, .hotbar-slot, .backpack-slot');
      if (dropSlot && dropSlot !== stashDragState.slot) {
        const to = dropSlot.classList.contains('backpack-slot') ? 'backpack' : dropSlot.classList.contains('hotbar-slot') ? 'hotbar' : 'stash';
        hytopia.sendData({ type: 'moveItem', fromType: stashDragState.from, fromIndex: stashDragState.fromIndex, toType: to, toIndex: parseInt(dropSlot.getAttribute('data-position')) });
      }
    }
    finalizeDragVisuals();
    setEmptySlotHighlighting(false);
    document.removeEventListener('mousemove', handleDragMove);
    document.removeEventListener('mouseup', handleDragUp);
    stashDragState = null;
  };

  const updateDropHover = e => {
    const candidate = document.elementFromPoint(e.clientX, e.clientY)?.closest('.stash-slot, .hotbar-slot, .backpack-slot');
    const isEmpty = candidate && !candidate.querySelector('img');
    if (window.__dropHover && window.__dropHover !== candidate) {
      window.__dropHover.classList.remove('drop-hover');
      window.__dropHover = null;
    }
    if (isEmpty) {
      candidate.classList.add('drop-hover');
      window.__dropHover = candidate;
    }
  };

  const setEmptySlotHighlighting = enable => {
    document.querySelectorAll('.stash-slot, .backpack-slot, .hotbar-slot').forEach(slot => {
      if (enable) {
        if (!slot.querySelector('img')) {
          slot.classList.add('drop-target');
        } else {
          slot.classList.remove('drop-target');
        }
      } else {
        slot.classList.remove('drop-target', 'drop-hover');
      }
    });
    if (!enable) window.__dropHover = null;
  };

  const startDragGhost = slot => {
    if (!dragGhost) return;
    const img = slot.querySelector('img');
    const qty = slot.querySelector('.item-quantity');
    dragGhost.innerHTML = '';
    if (img) dragGhost.appendChild(img.cloneNode(true));
    if (qty) dragGhost.appendChild(qty.cloneNode(true));
    dragGhost.classList.add('active');
  };

  const stopDragGhost = () => {
    if (!dragGhost) return;
    dragGhost.classList.remove('active');
    dragGhost.innerHTML = '';
  };

  const updateGhostPosition = e => {
    if (!dragGhost) return;
    dragGhost.style.left = `${e.clientX + 15}px`;
    dragGhost.style.top = `${e.clientY - 15}px`;
    dragGhost.style.transform = 'translate(-50%, -50%)';
  };

  const updateSlot = (grid, position, itemData) => {
    const slot = grid.children[position];
    if (!slot) return;
    

    
    // Remove all rarity classes first
    slot.classList.remove('rarity-common', 'rarity-unusual', 'rarity-rare', 'rarity-epic', 'rarity-legendary', 'rarity-utopian');
    
    if (itemData.removed) {
      slot.innerHTML = '';
      slot._itemData = null;
      if (stashDragState && stashDragState.isDragging) {
        slot.classList.add('drop-target');
      } else {
        slot.classList.remove('drop-target');
      }
    } else {
      const isAmmo = itemData.name && (itemData.name.includes('9×19mm') || itemData.name.includes('7.62×39mm') || itemData.name.includes('12.7×108mm') || itemData.name.includes('12 Gauge'));
      const quantityDisplay = isAmmo && itemData.quantity > 1 ? 
        `<span class="ammo-label">${itemData.quantity}</span>` :
        itemData.quantity > 1 ? `<span class="item-quantity">${itemData.quantity}</span>` : '';
      
      slot.innerHTML = `<img src="${CDN_ASSETS_URL}/${itemData.iconImageUri}" alt="${itemData.name}">${quantityDisplay}`;
      slot._itemData = itemData;
      slot._tooltipEnabled = true;
      
      // Add rarity class for stained glass effect
      const rarity = itemData.rarity || 'common';
      slot.classList.add(`rarity-${rarity}`);
      
      slot.classList.remove('drop-target');
      slot.removeEventListener('mouseenter', createStashTooltip);
      slot.removeEventListener('mouseleave', removeStashTooltip);
      slot.removeEventListener('mousemove', updateStashTooltipPosition);
      slot.addEventListener('mouseenter', createStashTooltip);
      slot.addEventListener('mouseleave', removeStashTooltip);
      slot.addEventListener('mousemove', updateStashTooltipPosition);
    }
  };

  const createWeaponStatsHTML = (stats, description, ammoType) => {
    const ammoMap = { pistol: '9×19mm Parabellum', rifle: '7.62×39mm', sniper: '12.7×108mm', shotgun: '12 Gauge' };
    const bulletType = ammoMap[ammoType] || ammoType || '';
    const statsHTML = `
      <div class="key-stats">
        <div class="stat-group"><span class="stat-label">DMG</span><span class="stat-value">${stats.damage}</span></div>
        <div class="stat-group"><span class="stat-label">RPM</span><span class="stat-value">${stats.fireRate}</span></div>
        <div class="stat-group"><span class="stat-label">MAG</span><span class="stat-value">${stats.magazineSize}</span></div>
      </div>`;
    return { bulletType, statsHTML, description };
  };

  const createStashTooltip = e => {
    const slot = e.currentTarget;
    const itemData = slot._itemData;
    if (!itemData || slot._tooltipEnabled === false) return;
    removeStashTooltip(e);
    const tooltip = document.createElement('div');
    tooltip.className = 'item-tooltip';
    const isWeapon = itemData.stats && itemData.ammoType;
    let tooltipHTML = `<div class="tooltip-header"><span class="tooltip-name rarity-${itemData.rarity || 'common'}"${itemData.rarityColor ? ` style="color: rgb(${itemData.rarityColor.r}, ${itemData.rarityColor.g}, ${itemData.rarityColor.b})"` : ''}>${itemData.name}</span></div>`;
    if (isWeapon) {
      const { bulletType, statsHTML, description: weaponDesc } = createWeaponStatsHTML(itemData.stats, itemData.description || '', itemData.ammoType || 'pistol');
      if (weaponDesc) tooltipHTML += `<div class="tooltip-description">${weaponDesc}</div>`;
      if (bulletType) tooltipHTML += `<div class="bullet-type">${bulletType}</div>`;
      tooltipHTML += statsHTML;
    } else if (itemData.description) {
      tooltipHTML += `<div class="tooltip-description">${itemData.description}</div>`;
    }
    if (itemData.quantity > 1) {
      tooltipHTML += `<div class="tooltip-quantity">Quantity: ${itemData.quantity}</div>`;
    }
    tooltip.innerHTML = tooltipHTML;
    document.body.appendChild(tooltip);
    slot._tooltip = tooltip;
    positionStashTooltip(e, tooltip);
  };

  const removeStashTooltip = e => {
    const slot = e.currentTarget;
    if (slot._tooltip) {
      slot._tooltip.remove();
      slot._tooltip = null;
    }
  };

  const updateStashTooltipPosition = e => {
    const slot = e.currentTarget;
    const tooltip = slot._tooltip;
    if (tooltip) positionStashTooltip(e, tooltip);
  };

  const positionStashTooltip = (e, tooltip) => {
    let left = e.clientX + 15;
    let top = e.clientY - 10;
    tooltip.style.display = 'block';
    const rect = tooltip.getBoundingClientRect();
    if (left + rect.width > window.innerWidth) left = e.clientX - rect.width - 15;
    if (top + rect.height > window.innerHeight) top = e.clientY - rect.height - 10;
    if (top < 10) top = 10;
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
  };

  hytopia.onData(data => {
    switch (data.type) {
      case 'hotbarUpdate':
        updateSlot(stashHotbarGrid, data.position, data);
        clearDropTargets();
        break;
      case 'backpackUpdate':
        updateSlot(stashBackpackGrid, data.position, data);
        clearDropTargets();
        break;
      case 'stashUpdate':
        updateSlot(stashGrid, data.position, data);
        clearDropTargets();
        break;
    }
  });

  const clearDropTargets = () => {
    document.querySelectorAll('.stash-slot, .backpack-slot, .hotbar-slot').forEach(slot => slot.classList.remove('drop-target', 'drop-hover'));
  };

  const finalizeDragVisuals = () => {
    clearDropTargets();
    stopDragGhost();
  };

  initialize();

  // Add fade-in effect on page load
  document.addEventListener('DOMContentLoaded', () => {
    const stashOverlay = document.querySelector('.stash-overlay');
    if (stashOverlay) {
      stashOverlay.style.opacity = '0';
      setTimeout(() => {
        stashOverlay.style.opacity = '1';
      }, 10);
    }
  });
</script>


