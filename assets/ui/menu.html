<link rel="stylesheet" href="{{CDN_ASSETS_URL}}/ui/css/app.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Anton&family=Oswald:wght@700;900&family=Roboto+Condensed:wght@700;900&display=swap" rel="stylesheet">
<!-- Only preload the main background image that's immediately needed -->
<link rel="preload" as="image" href="{{CDN_ASSETS_URL}}/ui/background.png">
<!-- Page Loading System -->
<div class="page-loading-spinner" id="page-loading-spinner"></div>
<div class="page-transition-overlay" id="page-transition-overlay"></div>

<div class="menu-background" style="background: url('{{CDN_ASSETS_URL}}/ui/background.png') center center / cover no-repeat;">
  <div class="background-overlay"></div>
  <div class="smoke-effect">
    <div class="smoke-layer smoke-layer-1"></div>
    <div class="smoke-layer smoke-layer-2"></div>
    <div class="smoke-layer smoke-layer-3"></div>
  </div>
</div>

  <div class="main-menu page-loading" id="main-menu-content">
    <!-- Top HUD - Always at top -->
    <div class="top-hud">

      
      <div class="hud-panel ui-panel" id="profile-hud">
        <div class="level-badge">
          <span class="level-label">LVL</span>
          <span class="level-value" id="hud-level">1</span>
        </div>
        <div class="hud-main">
          <div class="user-row">
            <div class="user-name" id="hud-username">Player</div>
            <div class="currency">
              <span class="currency-label">CREDITS</span>
              <span class="currency-value" id="hud-currency">0</span>
            </div>
          </div>
          <div class="xp-bar">
           <div class="xp-fill" id="hud-xp-fill"></div>
          </div>
          <div class="xp-text"><span id="hud-xp">0</span>/<span id="hud-xp-next">100</span> XP</div>
        </div>
      </div>
    </div>

    <!-- Center Panel - Main Menu -->
    <div class="center-panel">
      <div class="game-title">
        <h1 class="title-text" id="escape-title">ESCAPE</h1>
      </div>
      
      <div class="main-actions">
        <div id="session-chooser" class="ui-panel" style="margin-top: 0; padding: 12px; display: none; gap: 12px; align-items: stretch; flex-direction: column;">
          <div class="section-label">CHOOSE SESSION</div>
          <div class="session-grid">
            <div id="session-a" class="session-card" data-session="alpha" tabindex="0" style="flex:1; display:flex; flex-direction:column; gap:6px; cursor:pointer;">
              <div class="session-meta"><span class="session-pill session-pill-alpha">DAY</span></div>
              <div class="session-title">ALPHA</div>
              <div class="session-subtitle">TIME LEFT</div>
              <div class="session-timer-left" data-for-left="alpha">--:--</div>
              <div class="session-world-subtitle">WORLD TIME</div>
              <div class="session-timer-world" data-for-world="alpha">--:--</div>
            </div>
            <div id="session-b" class="session-card" data-session="omega" tabindex="0" style="flex:1; display:flex; flex-direction:column; gap:6px; cursor:pointer;">
              <div class="session-meta"><span class="session-pill session-pill-omega">NIGHT</span></div>
              <div class="session-title">OMEGA</div>
              <div class="session-subtitle">TIME LEFT</div>
              <div class="session-timer-left" data-for-left="omega">--:--</div>
              <div class="session-world-subtitle">WORLD TIME</div>
              <div class="session-timer-world" data-for-world="omega">--:--</div>
            </div>
          </div>
        </div>
        
        <button class="action-button primary active" id="deploy-button" data-action="deploy">
          <div class="button-content">
            <div class="button-text">
              <span class="button-title">DEPLOY</span>
            </div>
          </div>
        </button>
        
        <button class="action-button secondary" id="stash-button" data-action="openStash">
          <div class="button-content">
            <div class="button-text">
              <span class="button-title">STASH</span>
            </div>
          </div>
        </button>
        


        <button class="action-button secondary" id="career-button" data-action="openCareer">
          <div class="button-content">
            <div class="button-text">
              <span class="button-title">CAREER</span>
            </div>
          </div>
        </button>
        
        <button class="action-button secondary" id="market-button" data-action="openMarket">
          <div class="button-content">
            <div class="button-text">
              <span class="button-title">MARKET</span>
            </div>
          </div>
        </button>
      </div>
    </div>

    <!-- Bottom Party Bar -->
    <div class="bottom-party-bar">
      <div class="party-bar-content">
        <div class="party-label">PARTY</div>
        <div class="party-members-horizontal" id="party-members-horizontal">
          <!-- Party members will be dynamically populated here -->
        </div>
        <div class="party-actions-horizontal">
          <button class="party-action-btn" id="leave-party-button">
            <span class="btn-text">LEAVE</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div id="extraction-success" class="extraction-success ui-panel" hidden>
    <div class="success-title">Successful Extraction</div>
    <div class="success-subtitle">Gear kept in backpack and hotbar.</div>
  </div>
  <div id="death-banner" class="extraction-success ui-panel" hidden>
    <div class="success-title">You Died</div>
    <div class="success-subtitle" id="death-banner-sub">You were eliminated</div>
  </div>
  <div id="mia-banner" class="extraction-success ui-panel" hidden>
    <div class="success-title">M.I.A.</div>
    <div class="success-subtitle" id="mia-banner-sub">You went missing in action</div>
  </div>
</div>

<!-- Party Invite Popup -->
<div id="party-invite-popup" class="party-invite-popup" hidden>
  <div class="party-invite-content">
    <div class="party-invite-header">
      <h3>Party Invite</h3>
    </div>
    <div class="party-invite-body">
      <p><span id="invite-from-username"></span> invited you to join their party!</p>
      <div id="invite-timer" class="invite-timer">30s remaining</div>
    </div>
    <div class="party-invite-actions">
      <button id="accept-invite-btn" class="party-invite-btn accept">Accept</button>
      <button id="decline-invite-btn" class="party-invite-btn decline">Decline</button>
    </div>
  </div>
</div>






<!-- Stash overlay removed; dedicated stash.html is used -->

<!-- Scene UI templates not used on menu (defined in index.html) -->

<div class="backdrop-blur"></div> 

<script>
  const CDN_ASSETS_URL = '{{CDN_ASSETS_URL}}';
  // Slot constants live in dedicated pages

  // Page Loading & Transition System - Optimized
  const pageLoadingSpinner = document.getElementById('page-loading-spinner');
  const pageTransitionOverlay = document.getElementById('page-transition-overlay');
  const mainMenuContent = document.getElementById('main-menu-content');
  
  let isTransitioning = false;
  let transitionTimeout = null;

  // Initialize loading spinner
  function initializeLoadingSpinner() {
    if (pageLoadingSpinner) {
      pageLoadingSpinner.classList.add('active');
    }
  }

  // Page loading system with error handling
  function showPageLoading() {
    if (pageLoadingSpinner && !pageLoadingSpinner.classList.contains('active')) {
      pageLoadingSpinner.classList.add('active');
    }
  }

  function hidePageLoading() {
    if (pageLoadingSpinner && pageLoadingSpinner.classList.contains('active')) {
      pageLoadingSpinner.classList.remove('active');
    }
  }

  function showPageTransition() {
    if (pageTransitionOverlay && !pageTransitionOverlay.classList.contains('active')) {
      pageTransitionOverlay.classList.add('active');
    }
  }

  function hidePageTransition() {
    if (pageTransitionOverlay && pageTransitionOverlay.classList.contains('active')) {
      pageTransitionOverlay.classList.remove('active');
    }
  }

  function navigateToPage(pageType) {
    // Prevent multiple simultaneous transitions
    if (isTransitioning) {
      console.warn('Page transition already in progress, ignoring navigation request');
      return;
    }

    // Validate page type
    const validPageTypes = ['openStash', 'openCareer', 'openMarket'];
    if (!validPageTypes.includes(pageType)) {
      console.error(`Invalid page type: ${pageType}`);
      return;
    }

    isTransitioning = true;

    try {
      // Show transition overlay
      showPageTransition();
      
      // Add fade out animation to current content
      if (mainMenuContent) {
        mainMenuContent.classList.add('page-fade-out');
      }
      
      // Show loading spinner during transition
      showPageLoading();
      
      // Clear any existing timeout
      if (transitionTimeout) {
        clearTimeout(transitionTimeout);
      }
      
      // After fade out, navigate
      transitionTimeout = setTimeout(() => {
        try {
          hytopia.sendData({ type: pageType });
        } catch (error) {
          console.error('Failed to send navigation data:', error);
          // Revert transition on error
          revertTransition();
        }
      }, 300);
    } catch (error) {
      console.error('Navigation error:', error);
      revertTransition();
    }
  }

  function revertTransition() {
    isTransitioning = false;
    hidePageLoading();
    hidePageTransition();
    
    if (mainMenuContent) {
      mainMenuContent.classList.remove('page-fade-out');
    }
    
    if (transitionTimeout) {
      clearTimeout(transitionTimeout);
      transitionTimeout = null;
    }
  }

  // Initialize page when everything is loaded
  function initializePage() {
    try {
      // Hide loading spinner
      hidePageLoading();
      
      // Show main content with fade in
      if (mainMenuContent) {
        mainMenuContent.classList.remove('page-loading');
        mainMenuContent.classList.add('page-loaded', 'page-fade-in');
      }
      
      // Assets will be loaded when needed for better performance
    } catch (error) {
      console.error('Page initialization error:', error);
      // Fallback: show content without animation
      if (mainMenuContent) {
        mainMenuContent.classList.remove('page-loading');
        mainMenuContent.classList.add('page-loaded');
      }
    }
  }

  // Removed unnecessary preloading - assets will be loaded when needed

  // Wait for DOM and critical resources to load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializePage, 100);
    });
  } else {
    // DOM is already loaded
    setTimeout(initializePage, 100);
  }

  // Initialize loading spinner immediately
  initializeLoadingSpinner();

  // Handle page visibility changes (tab switching)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && isTransitioning) {
      // Page hidden during transition, revert
      revertTransition();
    }
  });

  // Handle window focus/blur
  window.addEventListener('blur', () => {
    if (isTransitioning) {
      // Window lost focus during transition, revert
      revertTransition();
    }
  });

  const deployButton = document.getElementById('deploy-button');
  const stashButton = document.getElementById('stash-button');
  const careerButton = document.getElementById('career-button');
  const marketButton = document.getElementById('market-button');
  const menuButtons = Array.from(document.querySelectorAll('.action-button'));
  const titleEl = document.getElementById('escape-title');
  // Progression now opens a dedicated page. Stash is also dedicated; no in-menu elements are used.

  // Legacy stash vars not needed on menu
  let extractionSuccessTimeout = null;

  deployButton.addEventListener('click', () => {
    // Check if player is in a party and is the host
    const currentPlayer = {
      username: document.getElementById('hud-username')?.textContent || 'Player',
      level: document.getElementById('hud-level')?.textContent || '1'
    };
    
    // For now, just deploy normally - party system will be integrated later
    hytopia.sendData({ type: 'deploy' });
  });

  stashButton.addEventListener('click', () => {
    // Add loading state to button
    stashButton.classList.add('loading');
    navigateToPage('openStash');
  });

  careerButton.addEventListener('click', () => {
    // Add loading state to button
    careerButton.classList.add('loading');
    navigateToPage('openCareer');
  });

  marketButton.addEventListener('click', () => {
    // Add loading state to button
    marketButton.classList.add('loading');
    navigateToPage('openMarket');
  });

  // Party functionality
  const leavePartyButton = document.getElementById('leave-party-button');

  leavePartyButton.addEventListener('click', () => {
    hytopia.sendData({ type: 'leave-party' });
  });

  // Party list management
  const partyMembersHorizontal = document.getElementById('party-members-horizontal');
  
  function updatePartyList(partyData) {
    if (!partyMembersHorizontal) return;
    
    // Clear existing party members
    partyMembersHorizontal.innerHTML = '';
    
    const maxMembers = partyData?.maxMembers || 4;
    const members = partyData?.members || [];
    
    // Get current player info to check if they're the host
    const currentPlayerUsername = document.getElementById('hud-username')?.textContent || 'Player';
    const currentPlayerMember = members.find(m => m.username === currentPlayerUsername);
    const isCurrentPlayerHost = currentPlayerMember?.isHost || false;
    
    // Create slots for all 4 party members
    for (let i = 0; i < maxMembers; i++) {
      const member = members[i];
      
      if (member) {
        // Real party member
        const memberElement = document.createElement('div');
        memberElement.className = 'party-member-horizontal';
        
        const firstLetter = member.username ? member.username.charAt(0).toUpperCase() : '?';
        const statusClass = member.status || 'ready';
        const isHost = member.isHost;
        const isCurrentPlayer = member.username === currentPlayerUsername;
        const canKick = isCurrentPlayerHost && !isCurrentPlayer && !isHost; // Host can kick non-host members, but not themselves
        
        memberElement.innerHTML = `
          <div class="member-avatar-small">
            <div class="avatar-placeholder-small">${firstLetter}</div>
          </div>
          <div class="member-info-horizontal">
            <div class="member-name-horizontal">${member.username || 'Unknown'}</div>
            <div class="member-level-horizontal">Level ${member.level || 1}</div>
          </div>
          <div class="member-status-horizontal">
            <span class="status-dot-small ${statusClass}"></span>
            ${isHost ? '<span class="host-badge">HOST</span>' : ''}
          </div>
          ${canKick ? '<div class="kick-button" title="Kick player">×</div>' : ''}
        `;
        
        // Add kick functionality for hosts
        if (canKick) {
          const kickButton = memberElement.querySelector('.kick-button');
          if (kickButton) {
            kickButton.addEventListener('click', (e) => {
              e.stopPropagation();
              if (confirm(`Are you sure you want to kick ${member.username} from the party?`)) {
                hytopia.sendData({
                  type: 'kick-player',
                  username: member.username
                });
              }
            });
          }
        }
        
        partyMembersHorizontal.appendChild(memberElement);
      } else {
        // Empty slot
        const emptySlot = document.createElement('div');
        emptySlot.className = 'party-member-horizontal empty clickable';
        emptySlot.innerHTML = `
          <div class="member-avatar-small">
            <div class="avatar-placeholder-small">+</div>
          </div>
          <div class="member-info-horizontal">
            <div class="member-name-horizontal">Empty Slot</div>
            <div class="member-level-horizontal">Click to invite</div>
          </div>
          <div class="member-status-horizontal">
            <span class="status-dot-small offline"></span>
          </div>
        `;
        
        // Add click handler for inviting
        emptySlot.addEventListener('click', () => {
          const username = prompt('Enter player username to invite:');
          if (username && username.trim()) {
            hytopia.sendData({ 
              type: 'send-party-invite', 
              username: username.trim() 
            });
          }
        });
        
        partyMembersHorizontal.appendChild(emptySlot);
      }
    }
  }

  // Listen for party data updates
  hytopia.onData(data => {
    // Handle icon preloading
    handleIconPreloading(data);
    
    if (data.type === 'party-update') {
      updatePartyList(data.partyData);
    } else if (data.type === 'party-disbanded') {
      // Create a new solo party for the current player
      const currentPlayer = {
        username: document.getElementById('hud-username')?.textContent || 'Player',
        level: parseInt(document.getElementById('hud-level')?.textContent || '1'),
        status: 'ready'
      };
      
      updatePartyList({
        members: [currentPlayer],
        maxMembers: 4
      });
    } else if (data.type === 'party-kicked') {
      // Create a new solo party for the kicked player
      const currentPlayer = {
        username: document.getElementById('hud-username')?.textContent || 'Player',
        level: parseInt(document.getElementById('hud-level')?.textContent || '1'),
        status: 'ready'
      };
      
      updatePartyList({
        members: [currentPlayer],
        maxMembers: 4
      });
      
      // Show notification
      if (data.reason) {
        alert(`You were kicked from the party: ${data.reason}`);
      }
    }
  });

  // Initialize with current player data (if available)
  function initializePartyList() {
    // For now, show just the current player until party system is implemented
    const currentPlayer = {
      username: document.getElementById('hud-username')?.textContent || 'Player',
      level: parseInt(document.getElementById('hud-level')?.textContent || '1'),
      status: 'ready'
    };
    
    updatePartyList({
      members: [currentPlayer],
      maxMembers: 4
    });
  }

  // Initialize party list when page loads
  setTimeout(initializePartyList, 100);





  // Party invite popup handling
  let currentInviteId = null;
  let inviteTimer = null;
  let timeRemaining = 30;

  const partyInvitePopup = document.getElementById('party-invite-popup');
  const inviteFromUsername = document.getElementById('invite-from-username');
  const acceptInviteBtn = document.getElementById('accept-invite-btn');
  const declineInviteBtn = document.getElementById('decline-invite-btn');
  const inviteTimerElement = document.getElementById('invite-timer');

  // Ensure popup is hidden on page load
  if (partyInvitePopup) {
    partyInvitePopup.hidden = true;
  }

  function showInvite(inviteId, fromUsername) {
    currentInviteId = inviteId;
    inviteFromUsername.textContent = fromUsername;
    partyInvitePopup.hidden = false;
    
    // Start countdown timer
    timeRemaining = 30;
    updateTimer();
    inviteTimer = setInterval(updateTimer, 1000);
  }

  function hideInvite() {
    partyInvitePopup.hidden = true;
    currentInviteId = null;
    
    if (inviteTimer) {
      clearInterval(inviteTimer);
      inviteTimer = null;
    }
  }

  function updateTimer() {
    timeRemaining--;
    
    if (timeRemaining <= 0) {
      hideInvite();
      return;
    }

    inviteTimerElement.textContent = `${timeRemaining}s remaining`;
    
    // Update timer color based on time remaining
    inviteTimerElement.className = 'invite-timer';
    if (timeRemaining <= 10) {
      inviteTimerElement.classList.add('danger');
    } else if (timeRemaining <= 20) {
      inviteTimerElement.classList.add('warning');
    }
  }

  acceptInviteBtn.addEventListener('click', () => {
    if (currentInviteId) {
      hytopia.sendData({ type: 'accept-party-invite', inviteId: currentInviteId });
      hideInvite();
    }
  });

  declineInviteBtn.addEventListener('click', () => {
    if (currentInviteId) {
      hytopia.sendData({ type: 'decline-party-invite', inviteId: currentInviteId });
      hideInvite();
    }
  });

  // Listen for party-related data
  hytopia.onData(data => {
    // Handle icon preloading
    handleIconPreloading(data);
    
    switch (data.type) {
      case 'party-invite':
        showInvite(data.inviteId, data.fromUsername);
        break;
        
      case 'party-invite-accepted':
        showMessage(`${data.username} accepted your party invite!`, 'success');
        break;
        
      case 'party-invite-declined':
        showMessage(`${data.username} declined your party invite.`, 'error');
        break;
        
      case 'party-invite-expired':
        showMessage(`Party invite to ${data.username} expired.`, 'error');
        break;
    }
  });

  // Keyboard navigation for menu buttons
  function setActiveButton(btn) {
    menuButtons.forEach(b => b.classList.toggle('active', b === btn));
  }
  menuButtons.forEach((btn, idx) => {
    btn.setAttribute('tabindex', '0');
    btn.addEventListener('focus', () => setActiveButton(btn));
    btn.addEventListener('mouseover', () => setActiveButton(btn));
  });
  window.addEventListener('keydown', (e) => {
    const index = menuButtons.findIndex(b => b.classList.contains('active'));
    if (e.key === 'ArrowDown') {
      const next = menuButtons[(index + 1) % menuButtons.length];
      next.focus(); setActiveButton(next); e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      const prev = menuButtons[(index - 1 + menuButtons.length) % menuButtons.length];
      prev.focus(); setActiveButton(prev); e.preventDefault();
    } else if (e.key === 'Enter' || e.key === ' ') {
      const active = menuButtons[index] || deployButton;
      active.click(); e.preventDefault();
    }
  });

  // Match menu button width to the ESCAPE title width
  function applyButtonWidthFromTitle() {
    try {
      const rect = titleEl?.getBoundingClientRect();
      const titleWidth = rect?.width || 0;
      if (titleWidth > 0) {
        // Match to title width with comfortable padding; allow larger cap for 120px title
        const target = Math.max(260, Math.min(520, Math.round(titleWidth - 30)));
        document.documentElement.style.setProperty('--menu-button-width', `${target}px`);
      }
    } catch {}
  }
  requestAnimationFrame(applyButtonWidthFromTitle);
  window.addEventListener('resize', () => requestAnimationFrame(applyButtonWidthFromTitle));

  // Progression close handled in progression.html page

  // Stash open is handled in ui/stash.html

  function showExtractionSuccess(message) {
    const panel = document.getElementById('extraction-success');
    if (!panel) return;
    panel.style.display = 'block';
    // Auto-hide after a few seconds
    clearTimeout(extractionSuccessTimeout);
    extractionSuccessTimeout = setTimeout(() => {
      panel.style.display = 'none';
    }, 4000);
  }

  function showDeathBanner(message) {
    const panel = document.getElementById('death-banner');
    const sub = document.getElementById('death-banner-sub');
    if (!panel || !sub) return;
    sub.textContent = message || 'You were eliminated';
    panel.style.display = 'block';
    clearTimeout(extractionSuccessTimeout);
    extractionSuccessTimeout = setTimeout(() => {
      panel.style.display = 'none';
    }, 4000);
  }
  
  // Stash-related UI and logic lives in ui/stash.html
  
  hytopia.onData(data => {
    // Handle icon preloading
    handleIconPreloading(data);
    
    switch (data.type) {
      // Inventory is not managed on the menu page
      case 'hotbarUpdate':
      case 'backpackUpdate':
      case 'stashUpdate':
      case 'showStash':
      case 'hideStash':
        // handled on stash.html
        break;
      case 'extraction-success':
        showExtractionSuccess(data.message || 'Successful Extraction');
        break;
      case 'player-death':
        showDeathBanner(data.message || 'You were eliminated');
        break;
      case 'player-mia':
        (function(){
          const panel = document.getElementById('mia-banner');
          const sub = document.getElementById('mia-banner-sub');
          if (panel) {
            if (sub && data && data.message) sub.textContent = data.message;
            panel.style.display = 'block';
            clearTimeout(extractionSuccessTimeout);
            extractionSuccessTimeout = setTimeout(() => { panel.style.display = 'none'; }, 4000);
          }
        })();
        break;
      case 'enterMenu':
        // Request HUD sync on entering menu
        hytopia.sendData({ type: 'requestMenuHud' });
        break;
      case 'menu-hud':
        updateMenuHud(data);
        break;

      // Progression data not used here; progression opens in its own page
    }
  });
  
  // Removed legacy stash grid helpers from menu page

  function updateMenuHud(data) {
    try {
      // Cache sessions for live countdown
      if (Array.isArray(data.sessions)) {
        // Store session data for timer updates
        window.__sessions = data.sessions;
        window.__assignedSessionId = data.assignedSessionId || null;
        ensureSessionTicker();
      }
      if (typeof data.username === 'string') {
        var u = document.getElementById('hud-username');
        if (u) u.textContent = data.username;
      }
      if (typeof data.level === 'number') {
        document.getElementById('hud-level').textContent = String(data.level);
      }
      if (typeof data.currency === 'number') {
        document.getElementById('hud-currency').textContent = String(data.currency);
      }
      if (typeof data.xp === 'number' && typeof data.xpNext === 'number') {
        document.getElementById('hud-xp').textContent = String(data.xp);
        document.getElementById('hud-xp-next').textContent = String(data.xpNext);
        const pct = Math.max(0, Math.min(100, Math.floor((data.xp / Math.max(1, data.xpNext)) * 100)));
        var xpFillEl = document.getElementById('hud-xp-fill');
        if (xpFillEl) xpFillEl.style.width = pct + '%';
      }
      // Sessions
      try {
        const chooser = document.getElementById('session-chooser');
        if (Array.isArray(data.sessions) && data.sessions.length > 0) {
          chooser.style.display = 'flex';
          renderSessionTimers();
        } else {
          chooser.style.display = 'none';
        }
      } catch {}
    } catch {}
  }

  // Session selection handlers
  document.addEventListener('click', (e) => {
    const card = e.target.closest && e.target.closest('.session-card');
    if (card) {
      const sid = card.getAttribute('data-session');
      if (sid) {
        try { hytopia.sendData({ type: 'selectSession', sessionId: sid }); } catch {}
      }
    }
  });

  // Warn on deploy if no session selected
  deployButton.addEventListener('click', (e) => {
    const active = document.querySelector('.session-card.active');
    if (!active) {
      try { hytopia.sendData({ type: 'notification', message: 'Select a session (ALPHA or OMEGA) to deploy', color: 'FF0000' }); } catch {}
    }
  });

  // Live countdown using server-provided endsAt
  let __sessionTicker = null;
  function ensureSessionTicker() {
    if (__sessionTicker) return;
    __sessionTicker = setInterval(renderSessionTimers, 1000);
  }
  function renderSessionTimers() {
    try {
      const sessions = (window.__sessions || []);
      const assigned = window.__assignedSessionId || null;
      const now = Date.now();
      function fmt(left) {
        const sec = Math.max(0, Math.ceil(left / 1000));
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      }
      function applyFor(id) {
        const s = sessions.find(x => x.id === id);
        const elLeft = document.querySelector(`.session-timer-left[data-for-left="${id}"]`);
        const elWorld = document.querySelector(`.session-timer-world[data-for-world="${id}"]`);
        const card = document.querySelector(`.session-card[data-session="${id}"]`);
        if (s) {
          const left = fmt(Math.max(0, s.endsAt - now));
          if (elLeft) elLeft.textContent = left;
          if (elWorld) elWorld.textContent = s.worldTimeFormatted || '12:00 AM';
        }
        if (card) card.classList.toggle('active', assigned === id);
      }
      applyFor('alpha');
      applyFor('omega');
    } catch {}
  }

  // Removed legacy in-menu progression rendering and stash tooltip/grid helpers from menu page

  // Icon preloading system
  let preloadedIcons = new Map();
  
  function preloadIcons(iconUris) {
    if (!iconUris || !Array.isArray(iconUris)) return;
    
    iconUris.forEach(iconUri => {
      if (iconUri && !preloadedIcons.has(iconUri)) {
        const img = new Image();
        img.src = `${CDN_ASSETS_URL}/${iconUri}`;
        
        img.onload = () => {
          // Icon preloaded successfully
        };
        
        img.onerror = () => {
          // Icon failed to preload (silent fail)
        };
        
        preloadedIcons.set(iconUri, img);
      }
    });
  }
  
  function requestIconPreloading() {
    // Request market data to get all item icons
    hytopia.sendData({ type: 'requestMarketData' });
    
    // Request stash data to get inventory icons
    hytopia.sendData({ type: 'requestStashSync' });
    
    // Request progression data to get weapon icons
    hytopia.sendData({ type: 'requestProgressionData' });
  }
  
  // Icon preloading data handler
  function handleIconPreloading(data) {
    // Handle icon preloading for market data
    if (data.type === 'market-data') {
      const iconUris = [];
      
      // Collect market item icons
      if (data.items && Array.isArray(data.items)) {
        data.items.forEach(item => {
          if (item.iconImageUri) {
            iconUris.push(item.iconImageUri);
          }
        });
      }
      
      // Collect sellable item icons
      if (data.sellableItems && Array.isArray(data.sellableItems)) {
        data.sellableItems.forEach(item => {
          if (item.iconImageUri) {
            iconUris.push(item.iconImageUri);
          }
        });
      }
      
      if (iconUris.length > 0) {
        preloadIcons(iconUris);
      }
    }
    
    // Handle icon preloading for stash/inventory data
    else if (data.type === 'stashUpdate' || data.type === 'hotbarUpdate' || data.type === 'backpackUpdate') {
      if (data.iconImageUri) {
        preloadIcons([data.iconImageUri]);
      }
    }
    
    // Handle icon preloading for progression data
    else if (data.type === 'progression-overview') {
      const iconUris = [];
      
      if (data.weapons && Array.isArray(data.weapons)) {
        data.weapons.forEach(weapon => {
          if (weapon.iconImageUri) {
            iconUris.push(weapon.iconImageUri);
          }
        });
      }
      
      if (iconUris.length > 0) {
        preloadIcons(iconUris);
      }
    }
  }
  
  // Preload common static icons that we know will be used
  function preloadStaticIcons() {
    const staticIcons = [
      // Common weapon icons (only the ones that likely exist)
      'icons/pistol_m9.png',
      'icons/pistol_glock.png',
      'icons/rifle_akm.png',
      
      // Consumable icons
      'icons/medkit.png',
      
      // Valuable item icons
      'icons/gold_bar.png',
      'icons/diamonds.png',
      
      // Other common icons
      'icons/backpack.png'
    ];
    
    preloadIcons(staticIcons);
  }
  
  // Cleanup preloaded icons when menu is unloaded
  function cleanupPreloadedIcons() {
    preloadedIcons.clear();
  }
  
  // Clean up on page unload
  window.addEventListener('beforeunload', cleanupPreloadedIcons);
  window.addEventListener('unload', cleanupPreloadedIcons);
  
  // Start icon preloading when menu loads
  setTimeout(() => {
    preloadStaticIcons();
    requestIconPreloading();
  }, 1000);


</script>

<style>
  /* Title Text Spacing - Matching mainmenu.html */
  .title-text {
    font-family: 'Anton', sans-serif;
    font-size: 10rem;
    font-weight: 400;
    color: #ffffff;
    margin: 0;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    text-shadow: none;
    position: relative;
    line-height: 1;
    animation: none;
    text-align: center;
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
    transform: translateY(-1vh);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Session Text Spacing */
  .session-title {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0;
    line-height: 1.2;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
  }

  .session-subtitle, .session-world-subtitle {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 0.8rem;
    color: #e2e8f0;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0;
    line-height: 1.2;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
  }

  .session-timer-left, .session-timer-world {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 1rem;
    color: #f59e0b;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0;
    line-height: 1.2;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
  }

  .session-pill {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0;
    line-height: 1.2;
  }

  .session-pill-alpha {
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8), 0 0 8px rgba(0, 0, 0, 0.4);
  }

  .session-pill-omega {
    color: #000000;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8), 0 0 8px rgba(255, 255, 255, 0.4);
  }

  /* Button Text Spacing */
  .button-title {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 1.25rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #ffffff;
    margin: 0;
    line-height: 1.2;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
  }

  /* Party Text Spacing */
  .party-label {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0;
    line-height: 1.2;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
  }

  .member-name-horizontal {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0;
    line-height: 1.2;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
  }

  .member-level-horizontal {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 0.64rem;
    color: #94a3b8;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0;
    line-height: 1.2;
  }


</style>

<script>
  // Simple fade transition system
  function applyFadeTransition(element, type = 'in', duration = 300) {
    if (!element) return;
    
    // Remove existing fade classes
    element.classList.remove('fade-in', 'fade-out', 'fade-in-scale', 'fade-out-scale');
    
    // Add appropriate fade class
    element.classList.add(`fade-${type}`);
    
    // Remove class after animation completes
    setTimeout(() => {
      element.classList.remove(`fade-${type}`);
    }, duration);
  }

  // Page load fade in
  document.addEventListener('DOMContentLoaded', () => {
    const mainMenu = document.querySelector('.main-menu');
    if (mainMenu) {
      applyFadeTransition(mainMenu, 'in-scale');
    }
  });
</script>